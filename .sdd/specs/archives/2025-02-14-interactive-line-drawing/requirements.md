# Interactive Line Drawing Requirements

## Problem Summary
現状のキャンバスでは既存ラインの編集（長さ調整など）は可能だが、新しいラインをユーザー操作で追加する手段がなく、直線部分を描画するたびにデータを直接編集する必要がある。スナップ付きのリアルタイムプレビューと直感的な操作（ドラッグ＆ドロップ／2クリック）を備えた描画モードを実装し、紙図面に近い操作感と CAD 的な精度の両立を目指す。

## Acceptance Criteria
- [ ] 「直線描画」モードが有効なとき、マウスドラッグ (押下→ドラッグ→離す) で始点と終点を指定し、操作中はゴムひもプレビューを表示し、マウスアップ時にラインが確定して `ScaffoldLine` に追加される。
- [ ] 同モードで始点クリック→終点クリックの2クリック操作も対応し、1回目クリック後はカーソルに追従するプレビューラインを表示、2回目クリックで確定する。
- [ ] プレビューおよび確定したラインの座標は現在のスナップ単位 (`snapSize`) に従って丸められ、最小長さ・`snapSize * 2` の倍数制約など既存の長さバリデーションを満たさない場合は確定しない（ユーザーにエラー表示）。
- [ ] 描画完了後のラインは既存の選択・ハイライト・寸法ポップアップ編集フローに統合され、長さ表示や JSON エクスポートへ反映される。
- [ ] プレビュー線は 60fps を維持できる軽量描画で、`window` リサイズやステージ移動時も正しく追従し、Esc キーや右クリックでキャンセルできる。
- [ ] カラー／線種（実線・点線）の選択 UI を提供し、各ラインの `color`・`style` プロパティが state に保存され、描画・プレビュー時に反映される。
- [ ] 描画モード以外（編集・マーカーなど）ではプレビューやライン新規追加が無効化され、既存操作に影響しない。
- [ ] スクリーンリーダー対応として、描画モードに入ったことやライン確定／キャンセルをARIAライブリージョンで通知し、キーボード操作（Enter/Escape）で確定・キャンセルできる。

## Constraints & Dependencies
- 既存の `ScaffoldLine` 型・`lines` ステートを拡張してカラー／線種情報を保持し、`snapToGrid`・`recalculateLineWithLength` との整合を保つ。
- Konva と React の組み合わせで実装し、追加ライブラリは使用しない（既存依存関係内で完結）。
- 新たな JSON フォーマット変更が必要な場合は後方互換を考慮し、旧データ読み込み時のデフォルト値を定義する。
- パフォーマンス上、リスナーは必要最小限にし、ステージのドラッグ／ズーム拡張を見据えて変換ロジックをユーティリティ化する。

## Open Questions & Follow-Up Tasks
- カラー／線種のデフォルトや選択 UI の配置（ツールパレットかポップアップか）をどうするか要決定。
- 描画モード中に寸法ポップアップを同時に操作させるか、完了後のみ編集可能にするかの操作ルール。
- ライン ID 生成方法（連番・UUID）と既存ラインとの衝突回避方針。
- 描画キャンセル時のエラーメッセージ表示方法（トースト／ステータスバー／ツールヒント）。
- 既存 JSON を読み込んだときに `color`・`style` が無いデータをどう扱うか（自動補完 or マイグレーション）。

Requirements complete. Review content, then run `/sdd-design` or choose `/sdd-highway` to fast-track design, tasks, and implementation.
